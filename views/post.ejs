<%- include("partials/header.ejs") %>

<body class="d-flex flex-column min-vh-100">
<div class="container">
    <div class="comment-section">
        <!-- New Comment Form -->
        <div class="mb-4">
            <div class="d-flex gap-3">
                <img src="https://icons.veryicon.com/png/128/miscellaneous/xdh-font-graphics-library/anonymous-user.png" alt="User Avatar" class="user-avatar">
                <div class="flex-grow-1">
                     <form action="/submit" method="POST">
                    <textarea id="textArea" name="textArea" class="form-control comment-input" rows="3" placeholder="Write a comment..."></textarea>
                    
                    <div class="mt-3 text-end">
                        <button id="submit" type="submit" name="submit" class="btn btn-comment text-white">Post Comment</button>
                    </div>
                </form>
                </div>
            </div>
        </div>

        <!-- Comments List -->
        <% if (locals.userError) { %>
            <script>
              alert("<%= userError %>");
            </script>
          <% } %>
          
          <% if (locals.userComment) { %>
            <% userComment.forEach((comment, i) => { %>
              <div class="comments-list">
                <div class="comment-box" data-id="<%= comment.id %>">
                  <div class="d-flex gap-3">
                    <img src="https://icons.veryicon.com/png/128/miscellaneous/xdh-font-graphics-library/anonymous-user.png" class="user-avatar">
                    <div class="flex-grow-1">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Comment no.<%= i + 1 %></h6>
                      </div>
          
                      <!-- Read-only comment -->
                      <p class="mb-2 comment-text"><%= comment.comment %></p>
          
                      <!-- Editable input hidden by default -->
                      <form class="edit-form d-none" action="/edit/<%= comment.id %>" method="POST">
                        <input type="text" name="editComment" value="<%= comment.comment %>" class="form-control comment-input" required>
                        <div class="mt-2">
                          <button type="submit" class="btn btn-success btn-sm text-white">Save</button>
                          <button type="button" class="btn btn-secondary btn-sm cancel-edit">Cancel</button>
                        </div>
                      </form>
          
                      <!-- Action buttons -->
                      <% if (comment.user_id === currentUser.id) { %>
                        <div class="comment-actions mt-2">
                          <button class="btn-edit btn-delete text-white" data-edit-id="<%= comment.id %>">Edit</button>
                          <form action="/delete/<%= comment.id %>" method="POST" class="d-inline">
                            <button class="btn btn-danger btn-sm btn-delete text-white" type="submit">Delete</button>
                          </form>
                        </div>
                      <% } %>
                    </div>
                  </div>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <div class="comments-list">
              <div class="comment-box">
                <div class="d-flex gap-3">
                  <div class="flex-grow-1">
                    <p class="mb-2">There are no posted comments yet.</p>
                  </div>
                </div>
              </div>
            </div>
          <% } %>
    </div>
</div>

<script>
    document.querySelectorAll(".btn-edit").forEach(button => {
      button.addEventListener("click", function () {
        const commentId = this.getAttribute("data-edit-id");
        const box = document.querySelector(`.comment-box[data-id='${commentId}']`);
        box.querySelector(".comment-text").classList.add("d-none");
        box.querySelector(".edit-form").classList.remove("d-none");
      });
    });
  
    document.querySelectorAll(".cancel-edit").forEach(button => {
      button.addEventListener("click", function () {
        const form = this.closest(".edit-form");
        const box = form.closest(".comment-box");
        form.classList.add("d-none");
        box.querySelector(".comment-text").classList.remove("d-none");
      });
    });
  </script>
  
</body>
<%- include("partials/footer.ejs") %>